package command

import (
	"container/heap"
	"encoding/json"
	"fmt"
	"testing"
	"vyatta-cfg-go/internal/service/logic/command/operatetree"
	"vyatta-cfg-go/internal/service/logic/tools/priorqueue"
)

func TestGetPriorQue(t *testing.T) {

	jsonStr := "{\"name\":\"\",\"value\":null,\"operate\":null,\"path\":\"\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"interfaces\",\"value\":null,\"operate\":null,\"path\":\"interfaces\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"loopback\",\"value\":null,\"operate\":null,\"path\":\"interfaces loopback\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"lo\",\"value\":null,\"operate\":null,\"path\":\"interfaces loopback lo\",\"priority\":300,\"isLeaf\":false,\"childNode\":[{\"name\":\"ip\",\"value\":null,\"operate\":null,\"path\":\"interfaces loopback lo ip\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"source-validation\",\"value\":[\"strict\",\"strict\"],\"operate\":[\"set\",\"delete\"],\"path\":\"interfaces loopback lo ip source-validation\",\"priority\":0,\"isLeaf\":true,\"childNode\":null}]}]},{\"name\":\"zx\",\"value\":null,\"operate\":null,\"path\":\"interfaces loopback zx\",\"priority\":300,\"isLeaf\":false,\"childNode\":[{\"name\":\"ip\",\"value\":null,\"operate\":[\"set\"],\"path\":\"interfaces loopback zx ip\",\"priority\":0,\"isLeaf\":true,\"childNode\":null}]}]},{\"name\":\"ethernet\",\"value\":null,\"operate\":null,\"path\":\"interfaces ethernet\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"eth0\",\"value\":null,\"operate\":null,\"path\":\"interfaces ethernet eth0\",\"priority\":318,\"isLeaf\":false,\"childNode\":[{\"name\":\"ip\",\"value\":null,\"operate\":null,\"path\":\"interfaces ethernet eth0 ip\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"enable-arp-ignore\",\"value\":null,\"operate\":[\"set\",\"delete\"],\"path\":\"interfaces ethernet eth0 ip enable-arp-ignore\",\"priority\":0,\"isLeaf\":true,\"childNode\":null}]},{\"name\":\"address\",\"value\":[\"dhcp\"],\"operate\":[\"set\"],\"path\":\"interfaces ethernet eth0 address\",\"priority\":0,\"isLeaf\":true,\"childNode\":null},{\"name\":\"description\",\"value\":[\"OUTSIDE\"],\"operate\":[\"set\"],\"path\":\"interfaces ethernet eth0 description\",\"priority\":0,\"isLeaf\":true,\"childNode\":null}]},{\"name\":\"eth1\",\"value\":null,\"operate\":null,\"path\":\"interfaces ethernet eth1\",\"priority\":318,\"isLeaf\":false,\"childNode\":[{\"name\":\"address\",\"value\":[\"192.168.0.1/24\"],\"operate\":[\"set\"],\"path\":\"interfaces ethernet eth1 address\",\"priority\":0,\"isLeaf\":true,\"childNode\":null},{\"name\":\"description\",\"value\":[\"INSIDE\"],\"operate\":[\"set\"],\"path\":\"interfaces ethernet eth1 description\",\"priority\":0,\"isLeaf\":true,\"childNode\":null}]}]}]},{\"name\":\"system\",\"value\":null,\"operate\":null,\"path\":\"system\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"name-server\",\"value\":[\"123\",\"123\",\"456\",\"zxzx\"],\"operate\":[\"set\",\"delete\",\"set\",\"set\"],\"path\":\"system name-server\",\"priority\":400,\"isLeaf\":true,\"childNode\":null},{\"name\":\"host-name\",\"value\":[\"123\",\"123\",\"1234\"],\"operate\":[\"set\",\"delete\",\"set\"],\"path\":\"system host-name\",\"priority\":0,\"isLeaf\":true,\"childNode\":null},{\"name\":\"login\",\"value\":null,\"operate\":null,\"path\":\"system login\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"user\",\"value\":null,\"operate\":null,\"path\":\"system login user\",\"priority\":400,\"isLeaf\":false,\"childNode\":[{\"name\":\"vyos\",\"value\":null,\"operate\":[\"set\",\"delete\"],\"path\":\"system login user vyos\",\"priority\":0,\"isLeaf\":true,\"childNode\":null}]}]}]},{\"name\":\"nat\",\"value\":null,\"operate\":null,\"path\":\"nat\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"source\",\"value\":null,\"operate\":null,\"path\":\"nat source\",\"priority\":220,\"isLeaf\":false,\"childNode\":[{\"name\":\"rule\",\"value\":null,\"operate\":null,\"path\":\"nat source rule\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"100\",\"value\":null,\"operate\":null,\"path\":\"nat source rule 100\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"outbound-interface\",\"value\":[\"eth0\"],\"operate\":[\"set\"],\"path\":\"nat source rule 100 outbound-interface\",\"priority\":0,\"isLeaf\":true,\"childNode\":null},{\"name\":\"source\",\"value\":null,\"operate\":null,\"path\":\"nat source rule 100 source\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"address\",\"value\":[\"192.168.0.0/24\"],\"operate\":[\"set\"],\"path\":\"nat source rule 100 source address\",\"priority\":0,\"isLeaf\":true,\"childNode\":null}]},{\"name\":\"translation\",\"value\":null,\"operate\":null,\"path\":\"nat source rule 100 translation\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"address\",\"value\":[\"masquerade\"],\"operate\":[\"set\"],\"path\":\"nat source rule 100 translation address\",\"priority\":0,\"isLeaf\":true,\"childNode\":null}]}]}]}]}]},{\"name\":\"service\",\"value\":null,\"operate\":null,\"path\":\"service\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"ssh\",\"value\":null,\"operate\":null,\"path\":\"service ssh\",\"priority\":0,\"isLeaf\":false,\"childNode\":[{\"name\":\"disable-password-authentication\",\"value\":null,\"operate\":[\"set\"],\"path\":\"service ssh disable-password-authentication\",\"priority\":1000,\"isLeaf\":true,\"childNode\":null}]}]}]}\n"

	var opTree *operatetree.Node
	json.Unmarshal([]byte(jsonStr), &opTree)
	priorQue, err := GetPriorQue(opTree)
	if err != nil {
		fmt.Println(err)
		return
	}
	fmt.Printf("len:%v\n", len(priorQue))
	for len(priorQue) > 0 {
		node := heap.Pop(&priorQue)
		fmt.Printf("name:%v value:%v  prio:%v path:%v\n", node.(*priorqueue.Item).Node.Name, node.(*priorqueue.Item).Node.Value,
			node.(*priorqueue.Item).Node.Priority, node.(*priorqueue.Item).Node.Path)
	}
}
